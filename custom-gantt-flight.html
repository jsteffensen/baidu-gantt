<!DOCTYPE html>
<html style="height: 100%">
   <head>
       <meta charset="utf-8">
   </head>
   <body style="height: 100%; margin: 0">
       <div id="container" style="height: 100%"></div>
       <script type="text/javascript" src="echarts.min.js"></script>
	   <script type="text/javascript" src="airport-schedule.js"></script>
       <script type="text/javascript">
	   
			var dom = document.getElementById("container");
			var myChart = echarts.init(dom, null, {renderer: 'svg'});

			var HEIGHT_RATIO = 0.6;
			var DIM_GROUP_INDEX;
			var DIM_TIME_ARRIVAL = 1;
			var DIM_TIME_DEPARTURE = 2;

			var _cartesianXBounds = [];
			var _cartesianYBounds = [];
			var _rawData;

			_rawData = rawData;
			var X_SERIES = _rawData.flight;
			
			addIndividualColours();
			makeYaxisDimension();
			
			var Y_SERIES = _rawData.yAxisData;
			
			myChart.setOption(option = makeOption());

			setHandlers();

function addIndividualColours() {
	colors = ['#1abc9c','#2ecc71','#3498db','#9b59b6',
			  '#34495e','#16a085','#27ae60','#2980b9',
			  '#8e44ad','#2c3e50','#f1c40f','#e67e22',
			  '#e74c3c','#ecf0f1','#95a5a6','#f39c12',
			  '#d35400','#c0392b','#bdc3c7','#7f8c8d'];
			  
	pointer = 0;
	
	//Add colour dimension
	X_SERIES.dimensions.push("Colours");
	
	//Iterate over flights and add new colour to each
	for(i=0; i<X_SERIES.data.length; i++) {

		X_SERIES.data[i].push(colors[pointer]);
		
		pointer++;
		if(pointer>= colors.length) {
			pointer = 0;
		}
	}
	
}

function makeYaxisDimension() {

	//add dimension to group by
	X_SERIES.dimensions.push("groupBy");
	groupByDimension = X_SERIES.dimensions.length-1;
	X_SERIES.dimensions.push("groupIndex");
	groupIndex = X_SERIES.dimensions.length-1;
	DIM_GROUP_INDEX = groupIndex;
	
	for(i=0; i<X_SERIES.data.length; i++) {
		X_SERIES.data[i].push('group'+X_SERIES.data[i][0]);
	}

	yAxisData = {};
	yAxisData.dimensions = ["Name", "Type", "Near Bridge"];
	yAxisData.data = [];
	
	uniques = [];
	
	for(j=0; j<X_SERIES.data.length; j++) {
		
		//get index
		index = uniques.indexOf(X_SERIES.data[j][groupByDimension]);
		
		if(index > -1) {
			
			//group already exists - overwrite index in first column of flight data
			//TODO: add index pointer to end of flight data item
			X_SERIES.data[j].push(index);
			
		} else {
			//group has not been indexed on yAxis yet
			uniques.push(X_SERIES.data[j][groupByDimension]);
			yAxisData.data.push( [X_SERIES.data[j][groupByDimension], '-', '-'] );
			// try again - we just added it
			X_SERIES.data[j].push(uniques.indexOf(X_SERIES.data[j][groupByDimension]));
		}
		
	}

	_rawData.yAxisData = yAxisData;
}

function makeOption() {
    return {
		// custom html for tooltip
        tooltip: {
			trigger: 'item',
			formatter: function (params) {
			
				var optionDate = { year: 'numeric', month: 'long', day: 'numeric'};
				var optionTime = { hour: '2-digit', minute:  '2-digit'};

				endDateOnlyIfDifferent = new Date(params.data[1]).toLocaleDateString('da-DK', optionDate) == new Date(params.data[2]).toLocaleDateString('da-DK', optionDate) ? '' : ' - ' + new Date(params.data[2]).toLocaleDateString('da-DK', optionDate);
				tooltipContent = '<div style="line-height: 60%;"><p>' + 
					new Date(params.data[1]).toLocaleDateString('da-DK', optionDate) + endDateOnlyIfDifferent + 
					'</p><p>' + new Date(params.data[1]).toLocaleTimeString('da-DK', optionTime) + 
					' - ' + new Date(params.data[2]).toLocaleTimeString('da-DK', optionTime) + 
					'</p></div>';
				
				return tooltipContent;
			} 
        },
        animation: false,
        dataZoom: [{
            type: 'slider',
            xAxisIndex: 0,
            filterMode: 'weakFilter',
            height: 30,
            bottom: 0,
            start: 0,
            end: 26,
            handleIcon: 'M10.7,11.9H9.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
            handleSize: '80%',
            showDetail: true
        }, {
            type: 'inside',
            id: 'insideX',
            xAxisIndex: 0,
            filterMode: 'weakFilter',
            start: 0,
            end: 26,
            zoomOnMouseWheel: false,
            moveOnMouseMove: true
        }, {
            type: 'slider',
            yAxisIndex: 0,
            zoomLock: true,
            width: 10,
            right: 10,
            top: 70,
            bottom: 30,
            start: 95,
            end: 100,
            handleSize: 0,
            showDetail: false,
        }, {
            type: 'inside',
            id: 'insideY',
            yAxisIndex: 0,
            start: 95,
            end: 100,
            zoomOnMouseWheel: false,
            moveOnMouseMove: true,
            moveOnMouseWheel: true
        }],
        grid: {
            show: true,
            top: 50,
            bottom: 30,
            left: 150,
            right: 20,
            backgroundColor: '#fff',
            borderWidth: 1
        },
        xAxis: {
            type: 'time',
            position: 'top',
            splitLine: {
                lineStyle: {
                    color: ['#E9EDFF']
                }
            },
            axisLine: {
                show: true
            },
            axisTick: {
                lineStyle: {
                    color: '#929ABA'
                }
            },
            axisLabel: {
                color: '#929ABA',
                inside: false,
                align: 'center'
            }
        },
        yAxis: {
            axisTick: {show: true},
            splitLine: {show: true},
            axisLine: {show: true},
            axisLabel: {show: false},
            min: 0,
            max: Y_SERIES.data.length
        },
        series: [{
            id: 'flightData',
            type: 'custom',
            renderItem: renderGanttItem,
            dimensions: X_SERIES.dimensions,
            encode: {
                x: [DIM_TIME_ARRIVAL, DIM_TIME_DEPARTURE],
                y: DIM_GROUP_INDEX,
                tooltip: [DIM_GROUP_INDEX, DIM_TIME_ARRIVAL, DIM_TIME_DEPARTURE]
            },
            data: X_SERIES.data
        }, {
            type: 'custom',
            renderItem: renderAxisLabelItem,
            dimensions: Y_SERIES.dimensions,
            encode: {
                x: -1, // -1 Then this series will not controlled by x.
                y: 0
            },
            data: echarts.util.map(Y_SERIES.data, function (item, index) {
                return [index].concat(item);
            })
        }]
    };
}

function renderGanttItem(params, api) {

    var categoryIndex = api.value(DIM_GROUP_INDEX);
    var timeArrival = api.coord([api.value(DIM_TIME_ARRIVAL), categoryIndex]);
    var timeDeparture = api.coord([api.value(DIM_TIME_DEPARTURE), categoryIndex]);

    var coordSys = params.coordSys;
    _cartesianXBounds[0] = coordSys.x;
    _cartesianXBounds[1] = coordSys.x + coordSys.width;
    _cartesianYBounds[0] = coordSys.y;
    _cartesianYBounds[1] = coordSys.y + coordSys.height;

    var barLength = timeDeparture[0] - timeArrival[0];
    // Get the heigth corresponds to length 1 on y axis.
    var barHeight = api.size([0, 1])[1] * HEIGHT_RATIO;
    var x = timeArrival[0];
    var y = timeArrival[1] - barHeight;

    var flightNumber = api.value(3) + '';
    var flightNumberWidth = echarts.format.getTextRect(flightNumber).width;
    var text = (barLength > flightNumberWidth + 40 && x + barLength >= 180)
        ? flightNumber : flightNumber; //show flightnumber regardless if it fits inside task bar.
	
	
	var flightColour = api.value(10) + '';
		
    var rectNormal = clipRectByRect(params, {
        x: x, y: y, width: barLength, height: barHeight
    });
    var rectVIP = clipRectByRect(params, {
        x: x, y: y, width: (barLength) / 2, height: barHeight
    });
    var rectText = clipRectByRect(params, {
        x: x, y: y, width: barLength, height: barHeight
    });

    return {
        type: 'group',
        children: [{
            type: 'rect',
            shape: rectNormal,
            style: api.style(
				{opacity: '1.0', // set to 0.7 if you want to see overlapping bars
				 fill: flightColour})
        }, /*{
            type: 'rect',
            ignore: !rectVIP && !api.value(4),
            shape: rectVIP,
            //style: api.style({fill: '#ddb30b'})

        },*/ {
            type: 'rect',
            ignore: !rectText,
            shape: rectText,
            style: {
                fill: 'transparent',
                stroke: 'transparent',
                text: text,
                textFill: '#fff',
				fontFamily: 'Microsoft YaHei',
				textBorderColor: flightColour
            }
        }]
    };
}

//Y-axis labels
function renderAxisLabelItem(params, api) {
    var y = api.coord([0, api.value(0)])[1];
    if (y < params.coordSys.y + 5) {
        return;
    }
    return {
        type: 'group',
        position: [
            10,
            y
        ],
        children: [
		{
            type: 'path',
            shape: {
                d: 'M0,0 L0,-20 L38,-20 38,0 Z',
                x: 0,
                y: -20,
                width: 135,
                height: 20,
                layout: 'cover'
            },
            style: {
                fill: '#7f8c8d'
            }
        }, {
            type: 'text',
            style: {
                x: 35,
                y: -3,
                text: api.value(1),
                textVerticalAlign: 'bottom',
                textAlign: 'center',
                textFill: '#fff',
				fontFamily: 'Microsoft YaHei'
            }
        }, {
            type: 'text',
            style: {
                x: 120,
                y: -2,
                textVerticalAlign: 'bottom',
                textAlign: 'center',
                text: api.value(2),
                textFill: '#f1c40f',
				fontFamily: 'Microsoft YaHei'
            }
        }]
    };
}


function clipRectByRect(params, rect) {
    return echarts.graphic.clipRectByRect(rect, {
        x: params.coordSys.x,
        y: params.coordSys.y,
        width: params.coordSys.width,
        height: params.coordSys.height
    });
}

// -------------
//  Enable Drag
// -------------

function onDragSwitchClick(model, api, type) {
    _draggable = !_draggable;
    myChart.setOption({
        dataZoom: [{
            id: 'insideX',
            disabled: _draggable
        }, {
            id: 'insideY',
            disabled: _draggable
        }]
    });
    this.model.setIconStatus(type, _draggable ? 'emphasis' : 'normal');
}

function setHandlers() {

	myChart.on('click', function (param) {

        _selectRecord = {
            dataIndex: param.dataIndex,
            categoryIndex: param.value[DIM_GROUP_INDEX],
            timeArrival: param.value[DIM_TIME_ARRIVAL],
            timeDeparture: param.value[DIM_TIME_DEPARTURE]
        };
		
        alert(_rawData.flight.data[_selectRecord.dataIndex]);
        
    });


};

       </script>
   </body>
</html>